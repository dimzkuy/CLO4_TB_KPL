<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilih Jadwal - CinemaBook</title>
    <link rel="stylesheet" href="../styles/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <span class="logo-icon">üé¨</span>
                CinemaBook
            </div>
            <div class="navbar-user">
                <div class="user-icon" id="userInitial">U</div>
                <div class="username" id="usernameDisplay">Username</div>
                <button class="logout-btn" id="logoutBtn" onclick="handleLogout()">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Back Button -->
        <div class="back-navigation">
            <button onclick="goBack()" class="back-btn">
                ‚Üê Kembali ke Pilih Film
            </button>
        </div>

        <!-- Selected Movie Info -->
        <div class="selected-movie-info" id="selectedMovieInfo">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Header Section -->
        <div class="schedule-header">
            <h1 class="schedule-title">Pilih Jadwal Tayang</h1>
            <p class="schedule-subtitle">Pilih tanggal dan waktu yang sesuai untuk menonton</p>
        </div>

        <!-- Date Selection -->
        <div class="date-selector">
            <h3 class="date-title">Pilih Tanggal</h3>
            <div class="date-container" id="dateContainer">
                <!-- Dates will be populated by JavaScript -->
            </div>
        </div>

        <!-- Movie Schedule -->
        <div class="schedule-container" id="scheduleContainer">
            <!-- Movie schedules will be populated by JavaScript -->
        </div>
    </div>

    <!-- Scripts -->
    <script src="../scripts/SessionManager.js"></script>
    <script src="../scripts/MovieManager.js"></script>
    <script src="../scripts/NotificationManager.js"></script>
    <script src="../scripts/logout.js"></script>
    <script>
        // Initialize schedule data
        const scheduleData = {
            'Inception': {
                poster: '../img/Inception.jpeg',
                genre: 'Sci-Fi, Adventure',
                duration: '148 menit',
                rating: '4.8',
                showtimes: ['10:00', '13:30', '16:45', '19:30', '22:15']
            },
            'Interstellar': {
                poster: '../img/Interstelar.jpeg',
                genre: 'Adventure, Drama, Sci-Fi',
                duration: '169 menit',
                rating: '4.7',
                showtimes: ['09:30', '13:00', '16:30', '20:00']
            },
            'The Dark Knight': {
                poster: '../img/The_Dark_Knight.jpeg',
                genre: 'Action, Crime, Drama',
                duration: '152 menit',
                rating: '4.9',
                showtimes: ['11:00', '14:30', '18:00', '21:30']
            },
            'The Shawshank Redemption': {
                poster: '../img/The_Shawshank_Redemption.jpeg',
                genre: 'Drama, Crime',
                duration: '142 menit',
                rating: '4.6',
                showtimes: ['10:30', '14:00', '17:30', '21:00']
            }
        };

        let selectedDate = null;
        let selectedMovie = localStorage.getItem('filmDipilih');

        // Check if movie is selected
        if (!selectedMovie) {
            alert('Silakan pilih film terlebih dahulu');
            window.location.href = 'home.html';
        }

        // Check user login status - IMPROVED VERSION
        function checkUserLogin() {
            let currentUser = null;
            let isLoggedIn = false;

            // Try multiple ways to check login status
            try {
                // Method 1: SessionManager
                if (typeof SessionManager !== 'undefined') {
                    const sessionManager = SessionManager.getInstance();
                    if (sessionManager.isLoggedIn()) {
                        currentUser = sessionManager.getCurrentUser();
                        isLoggedIn = true;
                    }
                }
            } catch (error) {
                console.log('SessionManager check failed:', error);
            }

            // Method 2: Direct localStorage check
            if (!isLoggedIn) {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    try {
                        currentUser = JSON.parse(storedUser);
                        isLoggedIn = true;
                    } catch (error) {
                        console.log('localStorage parse failed:', error);
                    }
                }
            }

            console.log('Login check result:', { isLoggedIn, currentUser });
            return { isLoggedIn, currentUser };
        }

        // Go back function
        function goBack() {
            localStorage.removeItem('filmDipilih');
            window.location.href = 'home.html';
        }

        // Show selected movie info
        function showSelectedMovieInfo() {
            const movieInfo = scheduleData[selectedMovie];
            if (movieInfo) {
                const selectedMovieDiv = document.getElementById('selectedMovieInfo');
                selectedMovieDiv.innerHTML = `
                    <div class="selected-movie-card">
                        <img src="${movieInfo.poster}" alt="${selectedMovie}" class="selected-movie-poster">
                        <div class="selected-movie-details">
                            <h2 class="selected-movie-title">${selectedMovie}</h2>
                            <p class="selected-movie-genre">${movieInfo.genre}</p>
                            <div class="selected-movie-meta">
                                <span class="selected-movie-duration">‚è±Ô∏è ${movieInfo.duration}</span>
                                <span class="selected-movie-rating">‚≠ê ${movieInfo.rating}/5</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Generate dates for the next 7 days
        function generateDates() {
            const dateContainer = document.getElementById('dateContainer');
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const dateCard = document.createElement('div');
                dateCard.className = 'date-card';
                if (i === 0) {
                    dateCard.classList.add('active');
                    selectedDate = date.toISOString().split('T')[0];
                }
                
                const dayName = date.toLocaleDateString('id-ID', { weekday: 'short' });
                const dayNumber = date.getDate();
                const monthName = date.toLocaleDateString('id-ID', { month: 'short' });
                
                dateCard.innerHTML = `
                    <div class="date-day">${dayName}</div>
                    <div class="date-number">${dayNumber}</div>
                    <div class="date-month">${monthName}</div>
                `;
                
                dateCard.addEventListener('click', () => selectDate(dateCard, date));
                dateContainer.appendChild(dateCard);
            }
        }

        // Select date
        function selectDate(element, date) {
            document.querySelectorAll('.date-card').forEach(card => {
                card.classList.remove('active');
            });
            element.classList.add('active');
            selectedDate = date.toISOString().split('T')[0];
            generateSchedule();
        }

        // Generate movie schedule (only for selected movie)
        function generateSchedule() {
            const scheduleContainer = document.getElementById('scheduleContainer');
            scheduleContainer.innerHTML = '';

            const movieData = scheduleData[selectedMovie];
            if (movieData) {
                const scheduleCard = document.createElement('div');
                scheduleCard.className = 'schedule-card focused-movie';
                
                scheduleCard.innerHTML = `
                    <div class="schedule-times">
                        <h4 class="times-title">Pilih Jam Tayang untuk ${selectedMovie}</h4>
                        <div class="times-container">
                            ${movieData.showtimes.map(time => `
                                <button class="time-slot" onclick="bookTicket('${selectedMovie}', '${time}')">
                                    ${time}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                scheduleContainer.appendChild(scheduleCard);
            }
        }

        // Book ticket function - IMPROVED
        function bookTicket(movieTitle, showtime) {
            const loginStatus = checkUserLogin();
            
            if (!loginStatus.isLoggedIn) {
                alert('Silakan login terlebih dahulu untuk memesan tiket.');
                window.location.href = 'login.html';
                return;
            }

            // Save booking information
            localStorage.setItem('filmDipilih', movieTitle);
            localStorage.setItem('selectedShowTime', showtime);
            localStorage.setItem('selectedDate', selectedDate);
            
            console.log('Booking data saved:', {
                filmDipilih: movieTitle,
                selectedShowTime: showtime,
                selectedDate: selectedDate
            });
            
            // Show notification if available
            try {
                const notificationManager = NotificationManager.getInstance();
                notificationManager.success(`Jadwal dipilih: ${showtime} - Lanjut pilih kursi`);
            } catch (error) {
                alert(`Jadwal dipilih: ${showtime} - Lanjut pilih kursi`);
            }
            
            // Redirect to seat selection
            setTimeout(() => {
                window.location.href = 'pilih_kursi.html';
            }, 1000);
        }

        // Initialize user display
        function initializeUserDisplay() {
            const loginStatus = checkUserLogin();
            
            if (loginStatus.isLoggedIn && loginStatus.currentUser) {
                const userInitial = document.getElementById('userInitial');
                const usernameDisplay = document.getElementById('usernameDisplay');
                
                if (userInitial && usernameDisplay) {
                    userInitial.textContent = loginStatus.currentUser.username.charAt(0).toUpperCase();
                    usernameDisplay.textContent = loginStatus.currentUser.username;
                }
            } else {
                console.log('No user found, but continuing to show schedule page');
                // Don't redirect automatically, let user see schedule first
                // They'll be prompted to login when they try to book
                const userInitial = document.getElementById('userInitial');
                const usernameDisplay = document.getElementById('usernameDisplay');
                
                if (userInitial && usernameDisplay) {
                    userInitial.textContent = 'G';
                    usernameDisplay.textContent = 'Guest';
                }
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing jadwal page');
            
            showSelectedMovieInfo();
            generateDates();
            generateSchedule();
            initializeUserDisplay();
        });
    </script>
</body>
</html>